#!/usr/bin/env bash
#
# Pre-commit hook for PAI repository
#
# This hook performs THREE critical functions:
# 1. Documentation validation - Checks for broken links and missing files
# 2. Documentation updates - Automatically updates docs based on changes
# 3. Security scanning - Prevents sensitive content from being committed
#
# INSTALLATION:
# cp .claude/hooks/pre-commit-with-docs.template .git/hooks/pre-commit
# chmod +x .git/hooks/pre-commit
#
# Or use: bun run .claude/setup.sh
#

# Get the root of the git repository
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

# ============================================================================
# DOCUMENTATION VALIDATION PHASE
# ============================================================================
# Validates all markdown links point to existing files
# This BLOCKS the commit if broken links are found
# ============================================================================

echo -e "\033[1;36mğŸ“š Validating documentation...\033[0m"

if [ -f ".claude/hooks/validate-docs.ts" ]; then
    if ! bun run .claude/hooks/validate-docs.ts; then
        echo -e "\033[1;31mâŒ Documentation validation failed!\033[0m"
        echo -e "\033[1;31m   Fix broken links before committing.\033[0m"
        exit 1
    fi
else
    echo -e "\033[1;33mâš ï¸  validate-docs.ts not found, skipping validation\033[0m"
fi

# ============================================================================
# DOCUMENTATION UPDATE PHASE
# ============================================================================
# Automatically updates documentation based on what files were changed
# This is non-blocking - issues are reported but don't fail the commit
# ============================================================================

if [ -f ".claude/hooks/update-documentation.ts" ]; then
    if ! bun run .claude/hooks/update-documentation.ts; then
        echo -e "\033[1;33mâš ï¸  Documentation update encountered an issue (non-blocking)\033[0m"
        echo -e "\033[1;33m   The commit will proceed, but you may want to review documentation manually\033[0m"
    fi
fi

# ============================================================================
# SECURITY SCANNING PHASE
# ============================================================================
# Prevent sensitive content from being committed
# ============================================================================

echo -e "\033[1;36mğŸ”’ Scanning for sensitive content...\033[0m"

# Check for common sensitive patterns in staged files
SENSITIVE_PATTERNS=(
    "ANTHROPIC_API_KEY="
    "OPENAI_API_KEY="
    "sk-ant-"
    "sk-proj-"
    "password.*=.*['\"]"
    "@danielmiessler.com"
    "@unsupervised-learning.com"
)

STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    if echo "$STAGED_FILES" | xargs grep -l -E "$pattern" 2>/dev/null; then
        echo -e "\033[1;31mâŒ Found sensitive pattern: $pattern\033[0m"
        echo -e "\033[1;31m   Remove sensitive content before committing.\033[0m"
        exit 1
    fi
done

echo -e "\033[1;32mâœ… Pre-commit checks passed\033[0m"
exit 0
